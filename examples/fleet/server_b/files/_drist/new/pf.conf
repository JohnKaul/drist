# --------------------------------------------------------------
# PF Options (must come first)
# --------------------------------------------------------------
set skip on { lo0, bridge0 }            # Do not filter loopback/bridge traffic
scrub in                                # Normalize inbound packets

# --------------------------------------------------------------
# Interface definitions
# --------------------------------------------------------------
ext_if="TODO"
jailnet = "10.0.0.0/24"
icmp_types  = "{ unreach, echoreq }"
icmp6_types = "{ unreach, echoreq, timex, paramprob }"
inbound_tcp_services = "{ ssh, https }"
outbound_tcp_services = "{ ssh, domain, http, https, rsync }"
outbound_udp_services = "{ domain, ntp }"
#inbound_udp_services = "{ domain }"

# --------------------------------------------------------------
# Allowed ssh ips: Home Office, Bastion, System76 (laptop)
# --------------------------------------------------------------
ssh_source_ips = "{ TODO }"

# --------------------------------------------------------------
# Ignore non-routable ip addresses
# --------------------------------------------------------------
martians = "{ \
  0.0.0.0/8, \
  127.0.0.0/8, \
  169.254.0.0/16, \
  172.16.0.0/12, \
  192.0.2.0/24, \
  240.0.0.0/4 }"

# --------------------------------------------------------------
# NAT / Translation (must appear before filtering)
# --------------------------------------------------------------
nat on $ext_if inet from $jailnet to any -> ($ext_if)

# --------------------------------------------------------------
# Tables (persisted across reloads)
# --------------------------------------------------------------
table <blocked> persist

# --------------------------------------------------------------
# Default policy (filtering section)
# --------------------------------------------------------------
block all

# --------------------------------------------------------------
# Quick block rules – drops packets that match before any other rule
# --------------------------------------------------------------
block quick from <blocked>
block in quick on $ext_if from $martians to any
block out quick on $ext_if from any to $martians

# --------------------------------------------------------------
# SSH rate‑limiting (filtering)
# --------------------------------------------------------------
pass quick proto { tcp, udp } from $ssh_source_ips to any port ssh \
    flags S/SA keep state \
    (max-src-conn 15, max-src-conn-rate 5/3, overload <blocked> flush global)

# --------------------------------------------------------------
# Services you want to expose (filtering)
# --------------------------------------------------------------
pass out on $ext_if proto tcp from { self, $jailnet } to any port $outbound_tcp_services
pass in on $ext_if proto tcp from any to any port $inbound_tcp_services

# --------------------------------------------------------------
# Allow DNS (UDP)
# --------------------------------------------------------------
pass out on $ext_if proto udp to port $outbound_udp_services

# Allow ICMP (unreach, redirect, timex, echo‑request)
pass inet proto icmp icmp-type $icmp_types
pass inet6 proto icmp6 icmp6-type $icmp6_types

# Allow traceroute
pass out on $ext_if inet proto udp to port 33433:33626 # ipv4
pass out on $ext_if inet6 proto udp to port 33433:33626 # ipv6
